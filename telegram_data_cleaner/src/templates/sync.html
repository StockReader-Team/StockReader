<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Sync - Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Vazirmatn', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        .status-running {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50" x-data="syncApp()" x-init="init()">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-sync-alt text-4xl text-white"></i>
                    <div>
                        <h1 class="text-3xl font-bold text-white">Ù…Ø¯ÛŒØ±ÛŒØª Sync Ù‡ÙˆØ´Ù…Ù†Ø¯</h1>
                        <p class="text-white/80 text-sm mt-1">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† Ø§Ø² Ø¯Ø³Øª Ø¯Ø§Ø¯Ù† Ø¯Ø§Ø¯Ù‡</p>
                    </div>
                </div>
                <a href="/" class="text-white hover:text-white/80 transition flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-home"></i>
                    <span class="font-medium">Ø®Ø§Ù†Ù‡</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">

        <!-- Status Cards -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <!-- Forward Sync Status -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-arrow-down text-green-600 ml-2"></i>
                        Forward Sync (Ø¬Ø¯ÛŒØ¯)
                    </h2>
                    <span
                        x-show="status?.forward?.is_running"
                        class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold status-running">
                        <i class="fas fa-spinner fa-spin ml-1"></i>
                        Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
                    </span>
                    <span
                        x-show="!status?.forward?.is_running && status?.forward?.is_completed"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
                        <i class="fas fa-check ml-1"></i>
                        Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡
                    </span>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯Ù‡:</span>
                        <span class="font-bold text-lg text-green-600" x-text="status?.forward?.messages_synced || 0"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Offset ÙØ¹Ù„ÛŒ:</span>
                        <span class="font-semibold" x-text="status?.forward?.current_offset || 0"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Ø¢Ø®Ø±ÛŒÙ† sync:</span>
                        <span class="text-sm" x-text="formatDate(status?.forward?.last_sync)"></span>
                    </div>
                    <div x-show="status?.forward?.last_error" class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                        <i class="fas fa-exclamation-triangle ml-1"></i>
                        <span x-text="status?.forward?.last_error"></span>
                    </div>
                </div>
            </div>

            <!-- Backward Sync Status -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-arrow-up text-purple-600 ml-2"></i>
                        Backward Sync (Ù‚Ø¯ÛŒÙ…ÛŒ)
                    </h2>
                    <span
                        x-show="status?.backward?.is_running"
                        class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold status-running">
                        <i class="fas fa-spinner fa-spin ml-1"></i>
                        Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
                    </span>
                    <span
                        x-show="!status?.backward?.is_running && status?.backward?.is_completed"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
                        <i class="fas fa-check ml-1"></i>
                        Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡
                    </span>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù… Ø´Ø¯Ù‡:</span>
                        <span class="font-bold text-lg text-purple-600" x-text="status?.backward?.messages_synced || 0"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Offset ÙØ¹Ù„ÛŒ:</span>
                        <span class="font-semibold" x-text="status?.backward?.current_offset || 0"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Ø¢Ø®Ø±ÛŒÙ† sync:</span>
                        <span class="text-sm" x-text="formatDate(status?.backward?.last_sync)"></span>
                    </div>
                    <div x-show="status?.backward?.last_error" class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                        <i class="fas fa-exclamation-triangle ml-1"></i>
                        <span x-text="status?.backward?.last_error"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-6">
                <i class="fas fa-sliders-h text-blue-600 ml-2"></i>
                Ú©Ù†ØªØ±Ù„ Sync
            </h2>

            <!-- Settings -->
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù… Ø¯Ø± Ù‡Ø± Batch
                    </label>
                    <input
                        type="number"
                        x-model.number="batchSize"
                        min="100"
                        max="5000"
                        step="100"
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: 1000</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Ø­Ø¯Ø§Ú©Ø«Ø± Batch (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
                    </label>
                    <input
                        type="number"
                        x-model.number="maxBatches"
                        min="1"
                        class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"
                        placeholder="Ø®Ø§Ù„ÛŒ = Ù‡Ù…Ù‡">
                    <p class="text-xs text-gray-500 mt-1">Ø¨Ø±Ø§ÛŒ ØªØ³Øª: 5-10</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid md:grid-cols-3 gap-4">
                <!-- Auto Sync -->
                <button
                    @click="autoSync()"
                    :disabled="loading"
                    class="px-6 py-4 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-magic text-xl mb-2"></i>
                    <div class="font-bold">Auto Sync</div>
                    <div class="text-xs opacity-90">Ø¬Ø¯ÛŒØ¯ + Ù‚Ø¯ÛŒÙ…ÛŒ</div>
                </button>

                <!-- Forward Only -->
                <button
                    @click="forwardSync()"
                    :disabled="loading"
                    class="px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-arrow-down text-xl mb-2"></i>
                    <div class="font-bold">Forward ÙÙ‚Ø·</div>
                    <div class="text-xs opacity-90">ÙÙ‚Ø· Ø¬Ø¯ÛŒØ¯Ù‡Ø§</div>
                </button>

                <!-- Backward Only -->
                <button
                    @click="backwardSync()"
                    :disabled="loading"
                    class="px-6 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-arrow-up text-xl mb-2"></i>
                    <div class="font-bold">Backward ÙÙ‚Ø·</div>
                    <div class="text-xs opacity-90">ÙÙ‚Ø· Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒÙ‡Ø§</div>
                </button>
            </div>

            <!-- Reset Button -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button
                    @click="resetSync()"
                    :disabled="loading"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition disabled:opacity-50">
                    <i class="fas fa-redo ml-2"></i>
                    Reset Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Sync
                </button>
            </div>
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-bold text-blue-900 mb-3">
                <i class="fas fa-info-circle ml-2"></i>
                Ú†Ø·ÙˆØ± Ú©Ø§Ø± Ù…ÛŒÚ©Ù†Ù‡ØŸ
            </h3>
            <div class="space-y-2 text-blue-800">
                <p><strong>âœ… Auto Sync (ØªÙˆØµÛŒÙ‡ Ù…ÛŒØ´Ù‡):</strong> Ø§Ø¨ØªØ¯Ø§ Ù‡Ù…Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ù…ÛŒÚ¯ÛŒØ±Ù‡ØŒ Ø¨Ø¹Ø¯ Ø¨Ù‡ Ø³Ù…Øª Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒÙ‡Ø§ Ù…ÛŒØ±Ù‡. Ø¨Ø§ Ø§ÛŒÙ† Ø±ÙˆØ´ Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø² Ø¯Ø³Øª Ù†Ù…ÛŒØ±Ù‡.</p>
                <p><strong>ğŸ”½ Forward Sync:</strong> ÙÙ‚Ø· Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ (Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² offset=0 Ø´Ø±ÙˆØ¹ Ù…ÛŒÚ©Ù†Ù‡). Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¯Ø§ÙˆÙ… Ù…Ù†Ø§Ø³Ø¨Ù‡.</p>
                <p><strong>ğŸ”¼ Backward Sync:</strong> ÙÙ‚Ø· Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ (Ø§Ø² offset Ù‚Ø¨Ù„ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒØ¯Ù‡). Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ù†Ø§Ø³Ø¨Ù‡.</p>
                <p><strong>ğŸ’¾ ÙˆØ¶Ø¹ÛŒØª Sync:</strong> Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒØ´Ù‡ØŒ Ù¾Ø³ Ø¯Ø± ØµÙˆØ±Øª Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ø§Ø² Ù‡Ù…ÙˆÙ†Ø¬Ø§ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒØ¯Ù‡.</p>
            </div>
        </div>

        <!-- Progress Log -->
        <div x-show="logs.length > 0" class="mt-6 bg-gray-900 rounded-lg shadow-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-white font-bold">
                    <i class="fas fa-terminal ml-2"></i>
                    Ù„Ø§Ú¯ Ø¹Ù…Ù„ÛŒØ§Øª
                </h3>
                <button @click="logs = []" class="text-white/70 hover:text-white text-sm">
                    <i class="fas fa-trash ml-1"></i>
                    Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                </button>
            </div>
            <div class="space-y-1 max-h-64 overflow-y-auto">
                <template x-for="(log, index) in logs" :key="index">
                    <div class="text-sm font-mono" :class="{
                        'text-green-400': log.type === 'success',
                        'text-red-400': log.type === 'error',
                        'text-yellow-400': log.type === 'warning',
                        'text-gray-400': log.type === 'info'
                    }">
                        <span x-text="log.timestamp"></span>
                        <span x-text="log.message"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function syncApp() {
            return {
                status: null,
                batchSize: 1000,
                maxBatches: null,
                loading: false,
                logs: [],
                autoRefresh: null,

                async init() {
                    await this.loadStatus();
                    // Auto refresh every 5 seconds
                    this.autoRefresh = setInterval(() => {
                        this.loadStatus();
                    }, 5000);
                },

                addLog(message, type = 'info') {
                    const timestamp = new Date().toLocaleTimeString('fa-IR');
                    this.logs.unshift({ timestamp, message, type });
                    if (this.logs.length > 50) this.logs.pop();
                },

                async loadStatus() {
                    try {
                        const res = await fetch('/api/sync/status');
                        if (res.ok) {
                            this.status = await res.json();
                        }
                    } catch (e) {
                        console.error('Error loading status:', e);
                    }
                },

                async autoSync() {
                    if (this.loading) return;

                    this.loading = true;
                    this.addLog('ğŸš€ Ø´Ø±ÙˆØ¹ Auto Sync...', 'info');

                    try {
                        const params = new URLSearchParams({
                            batch_size: this.batchSize,
                            background: 'true'
                        });
                        if (this.maxBatches) params.append('max_batches', this.maxBatches);

                        const res = await fetch(`/api/sync/auto?${params}`, { method: 'POST' });
                        const data = await res.json();

                        if (res.ok) {
                            this.addLog('âœ… ' + data.message, 'success');
                        } else {
                            this.addLog('âŒ Ø®Ø·Ø§: ' + (data.detail || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'), 'error');
                        }
                    } catch (e) {
                        this.addLog('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
                    } finally {
                        this.loading = false;
                        await this.loadStatus();
                    }
                },

                async forwardSync() {
                    if (this.loading) return;

                    this.loading = true;
                    this.addLog('ğŸ”½ Ø´Ø±ÙˆØ¹ Forward Sync...', 'info');

                    try {
                        const params = new URLSearchParams({
                            batch_size: this.batchSize,
                            background: 'true'
                        });
                        if (this.maxBatches) params.append('max_batches', this.maxBatches);

                        const res = await fetch(`/api/sync/forward?${params}`, { method: 'POST' });
                        const data = await res.json();

                        if (res.ok) {
                            this.addLog('âœ… ' + data.message, 'success');
                        } else {
                            this.addLog('âŒ Ø®Ø·Ø§: ' + (data.detail || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'), 'error');
                        }
                    } catch (e) {
                        this.addLog('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
                    } finally {
                        this.loading = false;
                        await this.loadStatus();
                    }
                },

                async backwardSync() {
                    if (this.loading) return;

                    this.loading = true;
                    this.addLog('ğŸ”¼ Ø´Ø±ÙˆØ¹ Backward Sync...', 'info');

                    try {
                        const params = new URLSearchParams({
                            batch_size: this.batchSize,
                            background: 'true'
                        });
                        if (this.maxBatches) params.append('max_batches', this.maxBatches);

                        const res = await fetch(`/api/sync/backward?${params}`, { method: 'POST' });
                        const data = await res.json();

                        if (res.ok) {
                            this.addLog('âœ… ' + data.message, 'success');
                        } else {
                            this.addLog('âŒ Ø®Ø·Ø§: ' + (data.detail || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'), 'error');
                        }
                    } catch (e) {
                        this.addLog('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
                    } finally {
                        this.loading = false;
                        await this.loadStatus();
                    }
                },

                async resetSync() {
                    if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒØ®ÙˆØ§Ù‡ÛŒØ¯ ÙˆØ¶Ø¹ÛŒØª sync Ø±Ùˆ reset Ú©Ù†ÛŒØ¯ØŸ')) return;

                    this.loading = true;
                    this.addLog('ğŸ”„ Reset Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª...', 'warning');

                    try {
                        const res = await fetch('/api/sync/reset', { method: 'POST' });
                        const data = await res.json();

                        if (res.ok) {
                            this.addLog('âœ… ÙˆØ¶Ø¹ÛŒØª reset Ø´Ø¯', 'success');
                        } else {
                            this.addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± reset', 'error');
                        }
                    } catch (e) {
                        this.addLog('âŒ Ø®Ø·Ø§: ' + e.message, 'error');
                    } finally {
                        this.loading = false;
                        await this.loadStatus();
                    }
                },

                formatDate(dateStr) {
                    if (!dateStr) return 'Ù‡Ù†ÙˆØ² Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯Ù‡';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleString('fa-IR');
                    } catch {
                        return dateStr;
                    }
                }
            }
        }
    </script>
</body>
</html>
